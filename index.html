<script>
  const CACHE_KEY = "gold_price_cache_v2"; // version add kiya taaki purana cache na use ho
  const CACHE_TIME = 10 * 60 * 1000; // 10 min

  const refreshBtn = document.getElementById("refreshBtn");
  let isLoading = false;

  async function loadGoldPrice(force = false) {
    const errorEl = document.getElementById("error");
    errorEl.innerText = "";

    if (isLoading) return;
    isLoading = true;
    refreshBtn.disabled = true;
    refreshBtn.innerText = "Refreshing...";

    // Show loading in table too
    document.querySelectorAll("[id^='g']").forEach(el => el.innerText = "Loading...");

    try {
      // Cache check
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached && !force) {
        const parsed = JSON.parse(cached);
        if (Date.now() - parsed.time < CACHE_TIME) {
          applyPrice(parsed.price, "(cached)");
          return;
        }
      }

      // API call
      const res = await fetch("https://www.goldapi.io/api/XAU/USD", {
        headers: { "x-access-token": "goldapi-h1s19mkylgyry-io" } // â† apna key yahan daal
      });

      if (!res.ok) throw new Error(`API error: ${res.status}`);

      const data = await res.json();
      if (!data.price || isNaN(data.price)) throw new Error("Invalid price");

      // Save cache
      localStorage.setItem(
        CACHE_KEY,
        JSON.stringify({ price: data.price, time: Date.now() })
      );

      applyPrice(data.price, "");

    } catch (err) {
      console.error(err);
      errorEl.innerText = "Error loading fresh price. Showing cached data if available.";

      // Fallback to cache even if expired
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const parsed = JSON.parse(cached);
        applyPrice(parsed.price, "(old cached data)");
      } else {
        document.getElementById("ounceUSD").innerText = "Gold per Ounce (USD): Error";
      }
    } finally {
      isLoading = false;
      refreshBtn.disabled = false;
      refreshBtn.innerText = "Refresh Rates";
    }
  }

  function applyPrice(ounceUSD, note) {
    document.getElementById("ounceUSD").innerText = 
      `Gold per Ounce (USD): ${ounceUSD.toFixed(2)} ${note}`;

    const gold24gm = (ounceUSD * 1.4485 + 15) / 116.64;
    const gold22gm = gold24gm * 0.921;
    const gold21gm = gold24gm * 0.880;
    const gold18gm = gold24gm * 0.755;
    const tola21 = gold21gm * 11.664;

    document.getElementById("g24").innerText = gold24gm.toFixed(3);
    document.getElementById("g22").innerText = gold22gm.toFixed(3);
    document.getElementById("g21gm").innerText = gold21gm.toFixed(3);
    document.getElementById("g18").innerText = gold18gm.toFixed(3);
    document.getElementById("tola21").innerText = tola21.toFixed(2);

    const now = new Date();
    const muscatTime = now.toLocaleString("en-US", {
      timeZone: "Asia/Muscat",
      dateStyle: "medium",
      timeStyle: "short"
    });
    document.getElementById("time").innerText = 
      `Last updated: ${muscatTime} (Muscat Time)`;
  }

  window.addEventListener("load", () => loadGoldPrice());
  refreshBtn.addEventListener("click", () => loadGoldPrice(true));
</script>
